---
interface Props {
  slug: string;
}

const { slug } = Astro.props;
---

<span class="view-counter inline-flex items-center gap-1.5 text-sm text-muted-foreground" data-slug={slug}>
  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
  </svg>
  <span class="view-count">-</span>
  <span>views</span>
</span>

<script is:inline>
  function initViewCounter() {
    const counters = document.querySelectorAll('.view-counter');

    counters.forEach(counter => {
      const slug = counter.getAttribute('data-slug');
      const countEl = counter.querySelector('.view-count');
      if (!slug || !countEl) return;

      const storageKey = `views-${slug}`;
      const viewedKey = `viewed-${slug}`;

      // Get current count
      let count = parseInt(localStorage.getItem(storageKey) || '0', 10);

      // Increment if not viewed in this session
      if (!sessionStorage.getItem(viewedKey)) {
        count++;
        localStorage.setItem(storageKey, count.toString());
        sessionStorage.setItem(viewedKey, 'true');
      }

      // Animate the count
      let current = 0;
      const animate = () => {
        if (current < count) {
          current = Math.min(current + Math.ceil(count / 20), count);
          countEl.textContent = current.toLocaleString();
          requestAnimationFrame(animate);
        }
      };
      animate();
    });
  }

  initViewCounter();
  document.addEventListener('astro:after-swap', initViewCounter);
</script>

---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';

// Secret key protection - access via /stats?key=YOUR_SECRET
const STATS_SECRET = import.meta.env.STATS_SECRET || 'kyun2da-stats-2024';
const url = new URL(Astro.request.url);
const key = url.searchParams.get('key');
const isAuthorized = key === STATS_SECRET;

if (!isAuthorized) {
  return Astro.redirect('/404');
}

const allPosts = await getCollection('posts', ({ data }) => !data.draft);

// Calculate statistics
const totalPosts = allPosts.length;
const totalReadingTime = allPosts.reduce((acc, post) => acc + post.data.time, 0);

// Posts by category
const categoryStats = allPosts.reduce((acc, post) => {
  post.data.categories.forEach((cat) => {
    acc[cat] = (acc[cat] || 0) + 1;
  });
  return acc;
}, {} as Record<string, number>);

const sortedCategories = Object.entries(categoryStats)
  .sort((a, b) => b[1] - a[1]);

const maxCategoryCount = Math.max(...Object.values(categoryStats));

// Posts by year
const yearStats = allPosts.reduce((acc, post) => {
  const year = new Date(post.data.date).getFullYear();
  acc[year] = (acc[year] || 0) + 1;
  return acc;
}, {} as Record<number, number>);

const sortedYears = Object.entries(yearStats)
  .sort((a, b) => Number(b[0]) - Number(a[0]));

// Posts by month (last 12 months)
const now = new Date();
const monthlyData: { month: string; count: number }[] = [];
for (let i = 11; i >= 0; i--) {
  const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
  const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
  const count = allPosts.filter((post) => {
    const postDate = new Date(post.data.date);
    return postDate.getFullYear() === d.getFullYear() && postDate.getMonth() === d.getMonth();
  }).length;
  monthlyData.push({
    month: d.toLocaleDateString('ko-KR', { month: 'short' }),
    count,
  });
}

const maxMonthlyCount = Math.max(...monthlyData.map((d) => d.count), 1);

// Longest posts
const longestPosts = [...allPosts]
  .sort((a, b) => b.data.time - a.data.time)
  .slice(0, 5);

// Recent posts
const recentPosts = [...allPosts]
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime())
  .slice(0, 5);
---

<BaseLayout title="í†µê³„" description="ë¸”ë¡œê·¸ í†µê³„ ëŒ€ì‹œë³´ë“œ">
  <div class="max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8">ë¸”ë¡œê·¸ í†µê³„</h1>

    <!-- Overview Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-4 text-white">
        <div class="text-3xl font-bold">{totalPosts}</div>
        <div class="text-sm opacity-90">ì´ í¬ìŠ¤íŠ¸</div>
      </div>
      <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-4 text-white">
        <div class="text-3xl font-bold">{totalReadingTime}</div>
        <div class="text-sm opacity-90">ì´ ì½ê¸° ì‹œê°„ (ë¶„)</div>
      </div>
      <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-4 text-white">
        <div class="text-3xl font-bold">{Object.keys(categoryStats).length}</div>
        <div class="text-sm opacity-90">ì¹´í…Œê³ ë¦¬</div>
      </div>
      <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-4 text-white">
        <div class="text-3xl font-bold">{Math.round(totalReadingTime / totalPosts)}</div>
        <div class="text-sm opacity-90">í‰ê·  ì½ê¸° ì‹œê°„ (ë¶„)</div>
      </div>
    </div>

    <!-- Monthly Activity -->
    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 mb-8 border">
      <h2 class="text-xl font-bold mb-4">ì›”ë³„ í™œë™ (ìµœê·¼ 12ê°œì›”)</h2>
      <div class="flex items-end justify-between gap-2 h-32">
        {monthlyData.map((data) => (
          <div class="flex-1 flex flex-col items-center gap-1">
            <div
              class="w-full bg-blue-500 rounded-t transition-all hover:bg-blue-600"
              style={`height: ${(data.count / maxMonthlyCount) * 100}%`}
              title={`${data.count}ê°œì˜ í¬ìŠ¤íŠ¸`}
            />
            <span class="text-xs text-muted-foreground">{data.month}</span>
          </div>
        ))}
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-8 mb-8">
      <!-- Category Distribution -->
      <div class="bg-white dark:bg-slate-800 rounded-xl p-6 border">
        <h2 class="text-xl font-bold mb-4">ì¹´í…Œê³ ë¦¬ë³„ í¬ìŠ¤íŠ¸</h2>
        <div class="space-y-3">
          {sortedCategories.slice(0, 8).map(([category, count]) => (
            <div class="flex items-center gap-3">
              <a href={`/tags/${category}`} class="text-sm w-24 truncate hover:text-blue-500 no-underline">
                {category}
              </a>
              <div class="flex-1 bg-muted rounded-full h-4 overflow-hidden">
                <div
                  class="h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full transition-all"
                  style={`width: ${(count / maxCategoryCount) * 100}%`}
                />
              </div>
              <span class="text-sm text-muted-foreground w-8 text-right">{count}</span>
            </div>
          ))}
        </div>
      </div>

      <!-- Posts by Year -->
      <div class="bg-white dark:bg-slate-800 rounded-xl p-6 border">
        <h2 class="text-xl font-bold mb-4">ì—°ë„ë³„ í¬ìŠ¤íŠ¸</h2>
        <div class="space-y-3">
          {sortedYears.map(([year, count]) => (
            <div class="flex items-center gap-3">
              <span class="text-sm w-16">{year}ë…„</span>
              <div class="flex-1 bg-muted rounded-full h-4 overflow-hidden">
                <div
                  class="h-full bg-gradient-to-r from-green-500 to-teal-500 rounded-full"
                  style={`width: ${(count / Math.max(...Object.values(yearStats))) * 100}%`}
                />
              </div>
              <span class="text-sm text-muted-foreground w-8 text-right">{count}</span>
            </div>
          ))}
        </div>
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-8">
      <!-- Longest Posts -->
      <div class="bg-white dark:bg-slate-800 rounded-xl p-6 border">
        <h2 class="text-xl font-bold mb-4">ğŸ“š ê°€ì¥ ê¸´ í¬ìŠ¤íŠ¸</h2>
        <div class="space-y-3">
          {longestPosts.map((post, i) => (
            <a href={`/posts/${post.slug}`} class="flex items-center gap-3 group no-underline">
              <span class="text-lg font-bold text-muted-foreground w-6">{i + 1}</span>
              <span class="flex-1 truncate group-hover:text-blue-500 transition-colors">
                {post.data.title}
              </span>
              <span class="text-sm text-muted-foreground">{post.data.time}ë¶„</span>
            </a>
          ))}
        </div>
      </div>

      <!-- Recent Posts -->
      <div class="bg-white dark:bg-slate-800 rounded-xl p-6 border">
        <h2 class="text-xl font-bold mb-4">ğŸ• ìµœê·¼ í¬ìŠ¤íŠ¸</h2>
        <div class="space-y-3">
          {recentPosts.map((post) => (
            <a href={`/posts/${post.slug}`} class="flex items-center gap-3 group no-underline">
              <span class="flex-1 truncate group-hover:text-blue-500 transition-colors">
                {post.data.title}
              </span>
              <span class="text-sm text-muted-foreground whitespace-nowrap">
                {new Date(post.data.date).toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' })}
              </span>
            </a>
          ))}
        </div>
      </div>
    </div>
  </div>
</BaseLayout>
